name: Production Build & Submit

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'ios'
        type: choice
        options:
          - ios
          - android
          - all
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major
      auto_increment:
        description: 'Auto-increment patch version?'
        required: false
        default: true
        type: boolean
  push:
    branches:
      - production
    paths:
      - 'apps/mobile/app.json'
      - 'apps/mobile/eas.json'
      - 'apps/mobile/package.json'

permissions:
  contents: read

jobs:
  build-production:
    name: Build Production
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/mobile/package-lock.json

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: apps/mobile
        run: npm install

      - name: Get current version from app.json
        id: current_version
        working-directory: apps/mobile
        run: |
          VERSION=$(node -p "require('./app.json').expo.version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Get current EAS remote version
        id: remote_version
        working-directory: apps/mobile
        run: |
          # Get remote version using JSON output (requires EAS CLI 12.0.0+)
          # Try JSON first, fallback to parsing text output
          REMOTE_VERSION=$(eas build:version:get --platform ios --json --non-interactive 2>/dev/null | jq -r '.ios.appVersion // empty' || \
            eas build:version:get --platform ios --non-interactive 2>/dev/null | grep -i "appVersion" | head -1 | awk '{print $NF}' || \
            echo "not-set")
          
          if [ "$REMOTE_VERSION" == "not-set" ] || [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" == "null" ]; then
            REMOTE_VERSION="not-set"
          fi
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          echo "Remote version: $REMOTE_VERSION"

      - name: Determine version to use
        id: version_logic
        working-directory: apps/mobile
        run: |
          CURRENT="${{ steps.current_version.outputs.version }}"
          REMOTE="${{ steps.remote_version.outputs.remote_version }}"
          BUMP_TYPE="${{ github.event.inputs.version_bump }}"
          AUTO_INCREMENT="${{ github.event.inputs.auto_increment }}"
          
          # With remote version source, prioritize remote version
          # If version_bump is specified, increment from remote (or current if remote not set)
          if [ "$BUMP_TYPE" != "none" ]; then
            BASE_VERSION="$REMOTE"
            if [ "$BASE_VERSION" == "not-set" ]; then
              BASE_VERSION="$CURRENT"
            fi
            IFS='.' read -r major minor patch <<< "$BASE_VERSION"
            case "$BUMP_TYPE" in
              patch) patch=$((patch + 1)) ;;
              minor) minor=$((minor + 1)); patch=0 ;;
              major) major=$((major + 1)); minor=0; patch=0 ;;
            esac
            NEW_VERSION="$major.$minor.$patch"
          # If auto_increment and remote exists, increment patch
          elif [ "$AUTO_INCREMENT" == "true" ] && [ "$REMOTE" != "not-set" ]; then
            IFS='.' read -r major minor patch <<< "$REMOTE"
            patch=$((patch + 1))
            NEW_VERSION="$major.$minor.$patch"
          # Use remote version if available, otherwise fallback to app.json
          elif [ "$REMOTE" != "not-set" ]; then
            NEW_VERSION="$REMOTE"
          else
            NEW_VERSION="$CURRENT"
          fi
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Will use version: $NEW_VERSION"

      - name: Sync version to app.json (for reference only)
        working-directory: apps/mobile
        run: |
          NEW_VERSION="${{ steps.version_logic.outputs.new_version }}"
          # Update app.json for reference (not used in builds with remote source)
          node -e "
            const fs = require('fs');
            const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            appJson.expo.version = '$NEW_VERSION';
            // runtimeVersion is NOT updated - it only changes when native code changes
            fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2) + '\n');
          "
          echo "Synced version to app.json (reference only, remote version is used for builds)"

      - name: Check EAS remote version
        working-directory: apps/mobile
        id: check_remote_version
        run: |
          # Check current remote version (for info only)
          CURRENT_REMOTE=$(eas build:version:get --platform ios --json --non-interactive 2>/dev/null | jq -r '.ios.appVersion // empty' || echo "not-set")
          echo "current_remote=$CURRENT_REMOTE" >> $GITHUB_OUTPUT
          
          if [ "$CURRENT_REMOTE" == "not-set" ] || [ -z "$CURRENT_REMOTE" ] || [ "$CURRENT_REMOTE" == "null" ]; then
            echo "âš ï¸ No remote version found!"
            echo "ðŸ’¡ Set version manually first: eas build:version:set --platform ios"
            echo "ðŸ’¡ Or the build will prompt you to set it"
          else
            echo "âœ… Current remote version: $CURRENT_REMOTE"
          fi
          
          # Note: eas build:version:set is interactive and doesn't work well in CI/CD
          # Versions should be set manually before running builds
          # The build will use whatever version is currently set remotely

      - name: Build iOS Production
        if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all' || github.event_name == 'push'
        working-directory: apps/mobile
        env:
          EXPO_PUBLIC_SUPABASE_URL: https://heprlhlltebrxydgtsjs.supabase.co
          EXPO_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlcHJsaGxsdGVicnh5ZGd0c2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUxODcxNjQsImV4cCI6MjA2MDc2MzE2NH0.YRo1iZw06YSxqBhotBnD1d5jZxw7hHwswe1wKp8VpfA
          EXPO_PUBLIC_BACKEND_URL: https://staging-api.suna.so/v1
          EXPO_PUBLIC_USE_REVENUECAT: 'true'
          EXPO_PUBLIC_REVENUECAT_IOS_API_KEY: appl_UpcFYduOZYUgSqKPNvtzgXkPCeh
          EXPO_PUBLIC_REVENUECAT_ANDROID_API_KEY: incoming
        run: |
          eas build --profile production --platform ios --auto-submit --non-interactive --no-wait

      - name: Build Android Production
        if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all' || github.event_name == 'push'
        working-directory: apps/mobile
        env:
          EXPO_PUBLIC_SUPABASE_URL: https://heprlhlltebrxydgtsjs.supabase.co
          EXPO_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlcHJsaGxsdGVicnh5ZGd0c2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUxODcxNjQsImV4cCI6MjA2MDc2MzE2NH0.YRo1iZw06YSxqBhotBnD1d5jZxw7hHwswe1wKp8VpfA
          EXPO_PUBLIC_BACKEND_URL: https://staging-api.suna.so/v1
          EXPO_PUBLIC_USE_REVENUECAT: 'true'
          EXPO_PUBLIC_REVENUECAT_IOS_API_KEY: appl_UpcFYduOZYUgSqKPNvtzgXkPCeh
          EXPO_PUBLIC_REVENUECAT_ANDROID_API_KEY: incoming
        run: |
          eas build --profile production --platform android --auto-submit --non-interactive --no-wait

      - name: Summary
        run: |
          PLATFORM="${{ github.event.inputs.platform }}"
          if [ -z "$PLATFORM" ] || [ "${{ github.event_name }}" == "push" ]; then
            PLATFORM="all"
          fi
          echo "## ðŸš€ Production Build Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version_logic.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: $PLATFORM" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: Check EAS dashboard for progress" >> $GITHUB_STEP_SUMMARY
