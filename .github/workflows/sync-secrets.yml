name: Sync Secrets to EKS

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "sync" to confirm'
        required: true
      secret_name:
        description: 'AWS Secrets Manager secret name'
        required: true
        default: 'suna-env-prod'
      restart_deployment:
        description: 'Restart deployment after sync?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  id-token: write
  contents: read

jobs:
  sync:
    name: Sync Secrets to EKS
    runs-on: ubuntu-latest
    environment: production
    if: github.event.inputs.confirm == 'sync'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOYMENT_ROLE }}
          aws-region: us-west-2

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name suna-eks --region us-west-2

      - name: Fetch and apply secret
        run: |
          echo "Fetching secret from AWS Secrets Manager..."
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id "${{ github.event.inputs.secret_name }}" \
            --query SecretString \
            --output text)

          echo "Creating Kubernetes secret..."
          # Parse JSON keys into --from-literal args
          kubectl create secret generic suna-env -n suna \
            --from-env-file=<(echo "$SECRET_JSON" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for k, v in data.items():
              print(f'{k}={v}')
          ") \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "Secret synced successfully."

      - name: Restart deployment
        if: github.event.inputs.restart_deployment == 'true'
        run: |
          echo "Restarting deployment to pick up new secrets..."
          kubectl rollout restart deployment/suna-api -n suna
          kubectl rollout status deployment/suna-api -n suna \
            --timeout=300s
          echo "Deployment restarted successfully."

      - name: Verify
        run: |
          kubectl get secret suna-env -n suna -o jsonpath='{.metadata.creationTimestamp}'
          echo ""
          kubectl get pods -n suna
