name: Build, push and deploy

on:
  push:
    branches:
      - main
      - PRODUCTION
  repository_dispatch:
    types: [production-updated]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.get_tag_name.outputs.environment }}
      image_tag: ${{ steps.get_tag_name.outputs.branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'repository_dispatch' && 'PRODUCTION' || github.ref }}

      - name: Determine environment
        id: get_tag_name
        shell: bash
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH_NAME"
          
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]] || [[ "$BRANCH_NAME" == "PRODUCTION" ]]; then
            echo "branch=prod" >> $GITHUB_OUTPUT
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" == "main" ]]; then
            echo "branch=latest" >> $GITHUB_OUTPUT
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64
          tags: ghcr.io/${{ github.repository }}/suna-backend:${{ steps.get_tag_name.outputs.branch }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-staging:
    needs: build-and-push
    if: needs.build-and-push.outputs.environment == 'staging'
    runs-on: ubuntu-latest
    steps:
      - name: Validate staging secrets
        run: |
          if [ -z "${{ secrets.AWS_STAGING_HOST }}" ]; then
            echo "‚ùå Error: AWS_STAGING_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_STAGING_USERNAME }}" ]; then
            echo "‚ùå Error: AWS_STAGING_USERNAME secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_STAGING_KEY }}" ]; then
            echo "‚ùå Error: AWS_STAGING_KEY secret is not set"
            exit 1
          fi
          echo "‚úÖ All staging secrets are configured"

      - name: Deploy to staging
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.AWS_STAGING_HOST }}
          username: ${{ secrets.AWS_STAGING_USERNAME }}
          key: ${{ secrets.AWS_STAGING_KEY }}
          port: 22
          timeout: 300s
          script: |
            cd /home/ubuntu/suna/backend
            git fetch origin main
            git reset --hard origin/main
            
            echo "=== Pre-deployment disk usage ==="
            df -h / | tail -1
            
            # Clean up old images
            echo "=== Cleaning up old images ==="
            docker image prune -af --filter "until=24h" || true
            
            # Pull pre-built image from registry and deploy
            echo "=== Pulling and deploying services ==="
            docker compose pull
            docker compose up -d --remove-orphans
            
            # Post cleanup
            echo "=== Post-deployment cleanup ==="
            docker image prune -af --filter "until=1h" || true
            
            echo "=== Deployment complete ==="
            docker compose ps
            df -h / | tail -1

  # Deploy to Lightsail (existing production instance)
  deploy-production-lightsail:
    needs: build-and-push
    if: needs.build-and-push.outputs.environment == 'prod'
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOYMENT_ROLE }}
          aws-region: us-west-2

      - name: Validate production secrets
        run: |
          if [ -z "${{ secrets.AWS_PRODUCTION_HOST }}" ]; then
            echo "‚ùå Error: AWS_PRODUCTION_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_PRODUCTION_USERNAME }}" ]; then
            echo "‚ùå Error: AWS_PRODUCTION_USERNAME secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_PRODUCTION_KEY }}" ]; then
            echo "‚ùå Error: AWS_PRODUCTION_KEY secret is not set"
            exit 1
          fi
          echo "‚úÖ All production secrets are configured"

      - name: Deploy to Lightsail
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.AWS_PRODUCTION_HOST }}
          username: ${{ secrets.AWS_PRODUCTION_USERNAME }}
          key: ${{ secrets.AWS_PRODUCTION_KEY }}
          port: 22
          timeout: 300s
          script: |
            cd /home/ubuntu/suna/backend
            git fetch origin PRODUCTION
            git reset --hard origin/PRODUCTION
            
            echo "=== Pre-deployment disk usage ==="
            df -h / | tail -1
            
            # Clean up old images
            echo "=== Cleaning up old images ==="
            docker image prune -af --filter "until=24h" || true
            
            # Pull pre-built image from registry and deploy
            echo "=== Pulling and deploying services ==="
            docker compose pull
            docker compose up -d --remove-orphans
            
            # Post cleanup
            echo "=== Post-deployment cleanup ==="
            docker image prune -af --filter "until=1h" || true
            
            echo "=== Deployment complete ==="
            docker compose ps
            df -h / | tail -1

  # Deploy to ECS (new scalable production cluster)
  deploy-production-ecs:
    needs: build-and-push
    if: needs.build-and-push.outputs.environment == 'prod'
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOYMENT_ROLE }}
          aws-region: us-west-2

      - name: Deploy to ECS
        run: |
          echo "üöÄ Deploying to ECS cluster..."
          
          # Force new deployment to pull latest image
          aws ecs update-service \
            --cluster suna-ecs \
            --service suna-api-svc-6a0ece6 \
            --force-new-deployment \
            --region us-west-2
          
          echo "‚úÖ ECS deployment triggered"
          echo ""
          echo "üìä Waiting for deployment to stabilize..."
          
          # Wait for service to become stable (up to 10 minutes)
          aws ecs wait services-stable \
            --cluster suna-ecs \
            --services suna-api-svc-6a0ece6 \
            --region us-west-2 || {
              echo "‚ö†Ô∏è Deployment still in progress after timeout, checking status..."
              aws ecs describe-services \
                --cluster suna-ecs \
                --services suna-api-svc-6a0ece6 \
                --region us-west-2 \
                --query 'services[0].{Status:status,Desired:desiredCount,Running:runningCount,Pending:pendingCount}'
            }
          
          echo ""
          echo "üéâ ECS deployment complete!"
          
          # Show final status
          aws ecs describe-services \
            --cluster suna-ecs \
            --services suna-api-svc-6a0ece6 \
            --region us-west-2 \
            --query 'services[0].{Status:status,Desired:desiredCount,Running:runningCount}' \
            --output table
