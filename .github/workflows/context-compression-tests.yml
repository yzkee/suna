name: Context Compression Tests

# Run on PRs affecting context management, compression, or prompt caching
on:
  pull_request:
    paths:
      - 'backend/core/agentpress/context_manager.py'
      - 'backend/core/agentpress/prompt_caching.py'
      - 'backend/tests/core/agentpress/test_context_manager_compression.py'
      - 'backend/core/ai_models/**'
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/core/agentpress/context_manager.py'
      - 'backend/core/agentpress/prompt_caching.py'
      - 'backend/tests/core/agentpress/test_context_manager_compression.py'
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'pytest filter expression (e.g., "200k" or "500k" or "1m")'
        required: false
        type: string
        default: ''
      include_slow:
        description: 'Include slow performance tests'
        required: false
        type: boolean
        default: false

jobs:
  unit-tests:
    name: Unit Tests (Fast)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          
      - name: Install dependencies
        working-directory: backend
        run: |
          uv sync --frozen
          
      - name: Run unit tests (excluding large_context and slow)
        working-directory: backend
        env:
          PYTHONPATH: ${{ github.workspace }}/backend
        run: |
          # Run basic unit tests that don't require large context generation
          uv run pytest tests/core/agentpress/test_context_manager_compression.py \
            -v \
            -m "not large_context and not slow" \
            --tb=short \
            --no-header \
            -q
            
      - name: Test Summary
        if: always()
        run: |
          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Fast unit tests completed" >> $GITHUB_STEP_SUMMARY

  large-context-tests:
    name: Large Context Tests (200k, 500k, 1M)
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 20  # Allow up to 20 min for 1M token generation + compression
    
    strategy:
      fail-fast: false
      matrix:
        context_size: ['200k', '500k', '1M']
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          
      - name: Install dependencies
        working-directory: backend
        run: |
          uv sync --frozen
          
      - name: Run ${{ matrix.context_size }} context tests
        working-directory: backend
        env:
          PYTHONPATH: ${{ github.workspace }}/backend
        run: |
          # Build test filter - target the real large context test classes
          TEST_FILTER="${{ github.event.inputs.test_filter || format('TestRealLargeContext{0}', matrix.context_size) }}"
          
          echo "ðŸ§ª Running ${{ matrix.context_size }} context compression tests"
          echo "Filter: $TEST_FILTER"
          
          # Run tests with the class name filter (includes slow tests)
          uv run pytest tests/core/agentpress/test_context_manager_compression.py \
            -v \
            -k "$TEST_FILTER" \
            --tb=short \
            --timeout=600 \
            2>&1 | tee test_output.txt
            
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          
          # Create summary
          echo "## ${{ matrix.context_size }} Context Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Test Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -100 test_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          
          exit $TEST_EXIT_CODE

  performance-tests:
    name: Performance Tests (Optional)
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.event.inputs.include_slow == 'true' || github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          
      - name: Install dependencies
        working-directory: backend
        run: |
          uv sync --frozen
          
      - name: Run performance tests
        working-directory: backend
        env:
          PYTHONPATH: ${{ github.workspace }}/backend
        run: |
          echo "ðŸƒ Running performance benchmarks..."
          
          # Run slow tests BUT exclude large_context (those run in large-context-tests job)
          uv run pytest tests/core/agentpress/test_context_manager_compression.py \
            -v \
            -m "slow and not large_context" \
            --tb=short \
            --timeout=600 \
            2>&1 | tee perf_output.txt
            
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          
          echo "## Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Performance Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat perf_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          
          exit $TEST_EXIT_CODE

  all-tests-passed:
    name: All Compression Tests Passed
    runs-on: ubuntu-latest
    needs: [unit-tests, large-context-tests]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.unit-tests.result }}" == "failure" ] || \
             [ "${{ needs.large-context-tests.result }}" == "failure" ]; then
            echo "âŒ Some tests failed"
            exit 1
          fi
          echo "âœ… All compression tests passed"
          
      - name: Summary
        run: |
          echo "## Context Compression Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Large Context (200k/500k/1M) | ${{ needs.large-context-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What was tested:" >> $GITHUB_STEP_SUMMARY
          echo "- Token counting accuracy" >> $GITHUB_STEP_SUMMARY
          echo "- Tiered compression (tool outputs â†’ user messages â†’ assistant messages)" >> $GITHUB_STEP_SUMMARY
          echo "- Tool call pairing preservation during compression" >> $GITHUB_STEP_SUMMARY
          echo "- Middle-out message omission strategy" >> $GITHUB_STEP_SUMMARY
          echo "- Prompt caching integration" >> $GITHUB_STEP_SUMMARY
          echo "- Context limits: 200k, 500k, and 1M tokens" >> $GITHUB_STEP_SUMMARY
