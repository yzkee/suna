name: Desktop App Build

on:
  push:
    branches:
      - main
      - PRODUCTION
    paths:
      - 'apps/desktop/**'
      - '.github/workflows/desktop-build.yml'
  pull_request:
    paths:
      - 'apps/desktop/**'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/desktop/package-lock.json

      - name: Install dependencies
        working-directory: apps/desktop
        run: npm ci

      - name: Build macOS app (${{ matrix.arch }})
        working-directory: apps/desktop
        run: npm run build:mac -- --${{ matrix.arch }}
        env:
          # Skip notarization in CI (requires Apple Developer credentials)
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: List build outputs
        working-directory: apps/desktop
        run: ls -lah dist/

      - name: Rename artifacts with architecture
        working-directory: apps/desktop/dist
        run: |
          for file in *.dmg; do
            if [ -f "$file" ]; then
              base="${file%.dmg}"
              mv "$file" "${base}-${{ matrix.arch }}.dmg"
            fi
          done
          ls -lah

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kortix-macos-${{ matrix.arch }}-${{ github.sha }}
          path: |
            apps/desktop/dist/*.dmg
          retention-days: 30

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/desktop/package-lock.json

      - name: Install dependencies
        working-directory: apps/desktop
        run: npm ci

      - name: Build Windows app
        working-directory: apps/desktop
        run: npm run build:win
        env:
          # Skip code signing in CI (requires Windows code signing certificate)
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: List build outputs
        working-directory: apps/desktop
        run: dir dist\

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kortix-windows-${{ github.sha }}
          path: |
            apps/desktop/dist/*.exe
          retention-days: 30

  upload-to-r2:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/PRODUCTION'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./apps/desktop/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download macOS x64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: kortix-macos-x64-${{ github.sha }}
          path: ./artifacts/macos-x64

      - name: Download macOS ARM64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: kortix-macos-arm64-${{ github.sha }}
          path: ./artifacts/macos-arm64

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: kortix-windows-${{ github.sha }}
          path: ./artifacts/windows

      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install --update

      - name: Upload to Cloudflare R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Set environment prefix (staging vs production)
          if [[ "${{ github.ref }}" == "refs/heads/PRODUCTION" ]]; then
            ENV_PREFIX="production"
          else
            ENV_PREFIX="staging"
          fi
          
          echo "üì¶ Uploading to R2 bucket: $R2_BUCKET"
          echo "üè∑Ô∏è  Version: $VERSION"
          echo "üåç Environment: $ENV_PREFIX"
          
          # Upload macOS Intel (x64)
          for file in ./artifacts/macos-x64/*.dmg; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              aws s3 cp "$file" \
                "s3://$R2_BUCKET/desktop/$ENV_PREFIX/$VERSION/macos/$filename" \
                --endpoint-url "$R2_ENDPOINT" \
                --content-type "application/x-apple-diskimage"
              
              # Also upload as "latest" for easy access
              aws s3 cp "$file" \
                "s3://$R2_BUCKET/desktop/$ENV_PREFIX/latest/macos/$filename" \
                --endpoint-url "$R2_ENDPOINT" \
                --content-type "application/x-apple-diskimage"
              
              echo "‚úÖ Uploaded macOS x64: $filename"
            fi
          done
          
          # Upload macOS Apple Silicon (ARM64)
          for file in ./artifacts/macos-arm64/*.dmg; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              aws s3 cp "$file" \
                "s3://$R2_BUCKET/desktop/$ENV_PREFIX/$VERSION/macos/$filename" \
                --endpoint-url "$R2_ENDPOINT" \
                --content-type "application/x-apple-diskimage"
              
              # Also upload as "latest"
              aws s3 cp "$file" \
                "s3://$R2_BUCKET/desktop/$ENV_PREFIX/latest/macos/$filename" \
                --endpoint-url "$R2_ENDPOINT" \
                --content-type "application/x-apple-diskimage"
              
              echo "‚úÖ Uploaded macOS ARM64: $filename"
            fi
          done
          
          # Upload Windows
          for file in ./artifacts/windows/*.exe; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              aws s3 cp "$file" \
                "s3://$R2_BUCKET/desktop/$ENV_PREFIX/$VERSION/windows/$filename" \
                --endpoint-url "$R2_ENDPOINT" \
                --content-type "application/x-msdownload"
              
              # Also upload as "latest"
              aws s3 cp "$file" \
                "s3://$R2_BUCKET/desktop/$ENV_PREFIX/latest/windows/$filename" \
                --endpoint-url "$R2_ENDPOINT" \
                --content-type "application/x-msdownload"
              
              echo "‚úÖ Uploaded Windows: $filename"
            fi
          done
          
          echo "üéâ All files uploaded to R2!"

      - name: Generate download URLs
        env:
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/PRODUCTION" ]]; then
            ENV_PREFIX="production"
          else
            ENV_PREFIX="staging"
          fi
          
          echo "## üì• Download URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List all uploaded files and create URLs
          for file in ./artifacts/macos-x64/*.dmg; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "- **macOS Intel (x64)**: ${R2_PUBLIC_URL}/desktop/${ENV_PREFIX}/${VERSION}/macos/${filename}" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          for file in ./artifacts/macos-arm64/*.dmg; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "- **macOS Apple Silicon (ARM64)**: ${R2_PUBLIC_URL}/desktop/${ENV_PREFIX}/${VERSION}/macos/${filename}" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          for file in ./artifacts/windows/*.exe; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "- **Windows**: ${R2_PUBLIC_URL}/desktop/${ENV_PREFIX}/${VERSION}/windows/${filename}" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Latest (always current)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for file in ./artifacts/macos-x64/*.dmg; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "- **macOS Intel (x64)**: ${R2_PUBLIC_URL}/desktop/${ENV_PREFIX}/latest/macos/${filename}" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          for file in ./artifacts/macos-arm64/*.dmg; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "- **macOS Apple Silicon (ARM64)**: ${R2_PUBLIC_URL}/desktop/${ENV_PREFIX}/latest/macos/${filename}" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          for file in ./artifacts/windows/*.exe; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "- **Windows**: ${R2_PUBLIC_URL}/desktop/${ENV_PREFIX}/latest/windows/${filename}" >> $GITHUB_STEP_SUMMARY
            fi
          done

  create-release:
    needs: [build-macos, build-windows, upload-to-r2]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.create_release == 'true' ||
      github.ref == 'refs/heads/PRODUCTION'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./apps/desktop/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Download macOS x64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: kortix-macos-x64-${{ github.sha }}
          path: ./artifacts/macos-x64

      - name: Download macOS ARM64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: kortix-macos-arm64-${{ github.sha }}
          path: ./artifacts/macos-arm64

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: kortix-windows-${{ github.sha }}
          path: ./artifacts/windows

      - name: List all artifacts
        run: |
          echo "=== macOS x64 artifacts ==="
          ls -lah ./artifacts/macos-x64/
          echo "=== macOS ARM64 artifacts ==="
          ls -lah ./artifacts/macos-arm64/
          echo "=== Windows artifacts ==="
          ls -lah ./artifacts/windows/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: desktop-${{ steps.version.outputs.tag }}
          name: Desktop App ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            ./artifacts/macos-x64/*
            ./artifacts/macos-arm64/*
            ./artifacts/windows/*
          body: |
            ## Kortix Desktop App ${{ steps.version.outputs.version }}
            
            ### Downloads
            
            **macOS:**
            - **Apple Silicon (M1/M2/M3)**: Download the `-arm64.dmg` file
            - **Intel**: Download the `-x64.dmg` file
            
            **Windows:**
            - Download the `.exe` installer
            
            ### Installation
            
            **macOS:**
            1. Download the appropriate `.dmg` file for your Mac (Apple Silicon or Intel)
            2. Open the `.dmg` file
            3. Drag Kortix to your Applications folder
            4. Open Kortix from Applications
            
            **Windows:**
            1. Download and run the `.exe` installer
            2. Follow the installation wizard
            3. Launch Kortix from the Start Menu
            
            ---
            
            Built from commit: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [build-macos, build-windows, upload-to-r2]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build Status
        run: |
          MACOS_STATUS="${{ needs.build-macos.result }}"
          WINDOWS_STATUS="${{ needs.build-windows.result }}"
          R2_STATUS="${{ needs.upload-to-r2.result }}"
          
          echo "## üèóÔ∏è Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$MACOS_STATUS" == "success" ]; then
            echo "‚úÖ macOS (Intel + Apple Silicon): Success" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ macOS builds completed successfully!"
          else
            echo "‚ùå macOS (Intel + Apple Silicon): $MACOS_STATUS" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå macOS builds failed: $MACOS_STATUS"
          fi
          
          if [ "$WINDOWS_STATUS" == "success" ]; then
            echo "‚úÖ Windows: Success" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ Windows build completed successfully!"
          else
            echo "‚ùå Windows: $WINDOWS_STATUS" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå Windows build failed: $WINDOWS_STATUS"
          fi
          
          if [ "$R2_STATUS" == "success" ] || [ "$R2_STATUS" == "skipped" ]; then
            if [ "$R2_STATUS" == "success" ]; then
              echo "‚úÖ Cloudflare R2 Upload: Success" >> $GITHUB_STEP_SUMMARY
              echo "‚úÖ Files uploaded to R2!"
            else
              echo "‚è≠Ô∏è  Cloudflare R2 Upload: Skipped (not main/PRODUCTION branch)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ùå Cloudflare R2 Upload: $R2_STATUS" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå R2 upload failed: $R2_STATUS"
          fi
          
          if [ "$MACOS_STATUS" == "success" ] && [ "$WINDOWS_STATUS" == "success" ]; then
            echo ""
            echo "üéâ All desktop builds completed successfully!"
            exit 0
          else
            echo ""
            echo "‚ùå Some builds failed"
            exit 1
          fi
