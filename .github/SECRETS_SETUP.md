# GitHub Actions Secrets Setup Guide

This guide explains how to obtain and configure all the required secrets for the GitHub Actions deployment workflows.

## Required Secrets

### Staging Secrets

#### `AWS_STAGING_HOST`
**What it is:** The public IP address or hostname of your staging Lightsail instance.

**How to get it:**
1. Go to AWS Lightsail Console: https://lightsail.aws.amazon.com/
2. Find your staging instance
3. Copy the **Public IP address** (e.g., `54.214.185.26`)
4. Or use the Pulumi output:
   ```bash
   cd infra/staging
   pulumi stack output instancePublicIp
   ```

**Set in GitHub:**
- Go to: Repository → Settings → Secrets and variables → Actions
- Add secret: `AWS_STAGING_HOST`
- Value: The IP address (e.g., `54.214.185.26`)

---

#### `AWS_STAGING_USERNAME`
**What it is:** The SSH username for the staging server.

**Default value:** `ubuntu` (for Ubuntu instances)

**Set in GitHub:**
- Secret name: `AWS_STAGING_USERNAME`
- Value: `ubuntu`

---

#### `AWS_STAGING_KEY`
**What it is:** The SSH private key for accessing the staging server.

**How to get it:**
1. The key is generated by Pulumi and stored encrypted in `infra/staging/suna-staging-key.pem`
2. Decrypt it using the Pulumi passphrase:
   ```bash
   cd infra/staging
   # Make sure PULUMI_CONFIG_PASSPHRASE is set
   export PULUMI_CONFIG_PASSPHRASE="your-passphrase"
   
   # Decrypt the key (you'll need to check the crypto-utils.ts for exact command)
   # Or use the setup script which handles decryption
   ```

3. **Alternative:** If you have direct SSH access, you can generate a new key pair:
   ```bash
   ssh-keygen -t rsa -b 4096 -f staging-key -N ""
   # Copy the public key to the server:
   ssh-copy-id -i staging-key.pub ubuntu@<STAGING_IP>
   # Use staging-key (private key) as the secret value
   ```

**Set in GitHub:**
- Secret name: `AWS_STAGING_KEY`
- Value: The **entire** private key content (including `-----BEGIN RSA PRIVATE KEY-----` and `-----END RSA PRIVATE KEY-----`)

---

### Production Secrets

#### `AWS_PRODUCTION_HOST`
**What it is:** The public IP address or hostname of your production Lightsail instance.

**How to get it:**
1. Go to AWS Lightsail Console: https://lightsail.aws.amazon.com/
2. Find your production instance
3. Copy the **Public IP address**
4. Or use the Pulumi output:
   ```bash
   cd infra/cluster/aws
   pulumi stack output instancePublicIp
   ```

**Set in GitHub:**
- Secret name: `AWS_PRODUCTION_HOST`
- Value: The IP address

---

#### `AWS_PRODUCTION_USERNAME`
**What it is:** The SSH username for the production server.

**Default value:** `ubuntu` (for Ubuntu instances)

**Set in GitHub:**
- Secret name: `AWS_PRODUCTION_USERNAME`
- Value: `ubuntu`

---

#### `AWS_PRODUCTION_KEY`
**What it is:** The SSH private key for accessing the production server.

**How to get it:**
1. The key is generated by Pulumi and stored encrypted in `infra/cluster/aws/suna-prod-key.pem`
2. Decrypt it using the Pulumi passphrase (similar to staging)

**Set in GitHub:**
- Secret name: `AWS_PRODUCTION_KEY`
- Value: The **entire** private key content

---

### AWS IAM Role for GitHub Actions

#### `AWS_DEPLOYMENT_ROLE`
**What it is:** The ARN of an AWS IAM role that GitHub Actions can assume using OIDC (OpenID Connect).

**How to create it:**

1. **Create an OIDC Identity Provider in AWS IAM:**
   - Go to IAM Console → Identity providers
   - Click "Add provider"
   - Provider type: **OpenID Connect**
   - Provider URL: `https://token.actions.githubusercontent.com`
   - Audience: `sts.amazonaws.com`
   - Click "Add provider"

2. **Create an IAM Role:**
   - Go to IAM Console → Roles → Create role
   - Trusted entity type: **Web identity**
   - Identity provider: Select `token.actions.githubusercontent.com`
   - Audience: `sts.amazonaws.com`
   - Add condition (optional but recommended):
     - Condition key: `StringEquals`
     - Key: `token.actions.githubusercontent.com:aud`
     - Value: `sts.amazonaws.com`
   - Add another condition:
     - Condition key: `StringLike`
     - Key: `token.actions.githubusercontent.com:sub`
     - Value: `repo:YOUR_GITHUB_ORG/YOUR_REPO:*` (replace with your actual org/repo)
   - Click "Next"

3. **Attach Permissions:**
   - Add permissions needed for deployment (e.g., ECR access, ECS access, etc.)
   - Or create a custom policy with minimal required permissions
   - Click "Next"

4. **Name the Role:**
   - Role name: `GitHubActionsDeploymentRole` (or your preferred name)
   - Click "Create role"

5. **Get the Role ARN:**
   - After creation, click on the role
   - Copy the **Role ARN** (e.g., `arn:aws:iam::123456789012:role/GitHubActionsDeploymentRole`)

**Set in GitHub:**
- Secret name: `AWS_DEPLOYMENT_ROLE`
- Value: The full Role ARN (e.g., `arn:aws:iam::123456789012:role/GitHubActionsDeploymentRole`)

---

## Quick Setup Checklist

- [ ] `AWS_STAGING_HOST` - Staging server IP
- [ ] `AWS_STAGING_USERNAME` - Usually `ubuntu`
- [ ] `AWS_STAGING_KEY` - Staging SSH private key
- [ ] `AWS_PRODUCTION_HOST` - Production server IP
- [ ] `AWS_PRODUCTION_USERNAME` - Usually `ubuntu`
- [ ] `AWS_PRODUCTION_KEY` - Production SSH private key
- [ ] `AWS_DEPLOYMENT_ROLE` - AWS IAM Role ARN for GitHub Actions

---

## Testing the Secrets

After setting up all secrets, you can test the deployment by:

1. **For Staging:** Push to the `main` branch
2. **For Production:** 
   - Push to the `PRODUCTION` branch, OR
   - Run the "Update PRODUCTION Branch" workflow manually, which will trigger the deployment

---

## Troubleshooting

### "missing server host" error
- Check that `AWS_STAGING_HOST` or `AWS_PRODUCTION_HOST` is set and not empty
- Verify the IP address is correct

### SSH connection fails
- Verify the SSH key is correctly formatted (includes BEGIN/END lines)
- Check that the key matches the public key on the server
- Ensure the username is correct (`ubuntu` for Ubuntu instances)

### AWS role assumption fails
- Verify the OIDC provider is correctly configured
- Check the role trust policy includes your GitHub repository
- Ensure the role ARN is correct and includes the full path

---

## Security Notes

- ⚠️ **Never commit private keys or secrets to the repository**
- ✅ SSH keys in `infra/` are encrypted and safe to commit
- ✅ GitHub Secrets are encrypted at rest
- ✅ Use IAM roles with least-privilege permissions
- ✅ Regularly rotate SSH keys and review IAM permissions

